# モバイル開発 引き継ぎ書

最終更新: 2026-02-16  
対象リポジトリ: `/home/zer0/ドキュメント/NaviosProject/01-navios/navios`

## 1. 目的

モバイル開発着手前に、Web/モバイル共通のデータ契約を先に揃えるための改修を実施した。  
本書は、モバイル実装開始時に最初に読む前提の引き継ぎ資料。

## 2. 今回完了した改修（契約先行）

### 2.1 Event契約の追加項目
- `place_name?: string | null`
- `address_label?: string | null`

`latitude` / `longitude` は引き続き真実データ。  
`place_name` / `address_label` は表示・検索・導線用ラベルとして追加。

### 2.2 API契約の拡張
- `POST /api/events`
- `PUT /api/events/:id`

で以下を受け取れるように変更済み。
- `place_name`（任意）
- `address_label`（任意）

未指定時フォールバック:
- `place_name`: `title`
- `address_label`: 逆ジオコーディング結果（または既存値）

互換維持:
- 既存 `address` は `address_label` と同値で保存する運用に統一

### 2.3 Web表示の最小対応
- 地図ピンのポップアップに `place_name` / `address_label` を表示
- PC右下カードに `place_name` / `address_label` を表示
- 「Googleで開く」リンクを追加
- 詳細ページにも場所表示 + Googleリンクを追加

## 3. 変更ファイル一覧

- `navios/types/event.ts`
- `navios/prisma/schema.prisma`
- `navios/prisma/schema.supabase.prisma`
- `navios/lib/event-mapper.ts`
- `navios/app/api/events/route.ts`
- `navios/app/api/events/[id]/route.ts`
- `navios/components/event/EventPopup.tsx`
- `navios/components/map/MapInner.tsx`
- `navios/app/page.tsx`
- `navios/components/event/EventDetail.tsx`
- `navios/app/event/[id]/page.tsx`

## 4. モバイル実装時の契約（必須）

### 4.1 保存対象
- 必須: `latitude`, `longitude`, `title`, `content`, `event_image`, `start_at`, `end_at`
- 推奨: `place_name`, `address_label`

### 4.2 モバイル投稿フロー（推奨）
1. Google Places 検索で候補選択
2. 確定地点の `lat/lng` を取得
3. `place_name` に施設名/地点名
4. `address_label` に整形住所
5. `/api/events` へ送信

## 5. API送信例（モバイル）

```json
{
  "title": "朝市セール",
  "content": "地元野菜の特売です",
  "category": "sale",
  "tags": ["under_1000"],
  "latitude": 31.57371,
  "longitude": 130.345154,
  "place_name": "伊集院朝市会場",
  "address_label": "鹿児島県日置市伊集院町◯◯",
  "start_at": "2026-02-16T00:00:00.000Z",
  "end_at": "2026-02-16T09:00:00.000Z",
  "is_all_day": false,
  "event_image": "data:image/webp;base64,..."
}
```

## 6. 未完了/注意点

### 6.1 DB適用
Prisma schema は更新済み。  
ただし実行環境でのDB反映（migrate/db push）は別途実施が必要。

推奨コマンド（開発環境）:
```bash
cd /home/zer0/ドキュメント/NaviosProject/01-navios/navios
DATABASE_URL="file:/tmp/navios-dev.db" npm run prisma:generate
DATABASE_URL="file:/tmp/navios-dev.db" npx prisma db push
```

### 6.2 lint状況
`npm run lint` は既存別ファイル起因で失敗する状態（今回改修外）。
- `app/me/page.tsx`（warning）
- `components/layout/AuthControls.tsx`（warning）
- `lib/map-provider.ts`（warning）
- `scripts/prisma-generate.cjs`（error）

## 7. モバイル着手チェックリスト

1. この引き継ぎ書を読了
2. Prisma schema のDB反映
3. `POST /api/events` に `place_name/address_label` を含めて疎通確認
4. Google Places -> API投稿の最小1画面を実装
5. 投稿後にWeb側で場所表示とGoogleリンクが期待どおり出るか確認

