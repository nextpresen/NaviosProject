# Navios リファクタリング定義書

最終更新: 2026-02-16  
対象: `/home/zer0/ドキュメント/NaviosProject/01-navios/navios`

## 1. 背景

現状のプロジェクト容量は約1.3GB。内訳は以下。

- `node_modules`: 約844MB
- `.next`: 約443MB
- アプリ本体（`app/`, `components/`, `lib/` など）: 数百KB〜数MB規模

結論として、容量問題の主因は「成果物・依存物」であり、ソースコード肥大ではない。  
そのため、**運用最適化**と**コードリファクタリング**を分けて実施する。

## 2. 目的

1. 開発体験を維持しつつ、ローカル容量・ビルド時間・保守コストを下げる  
2. 地図機能、投稿機能、認証機能の変更容易性を上げる  
3. 障害時の原因特定を短くする

## 3. 非目的

- UIデザインの全面刷新
- 機能追加中心の開発
- DBの履歴削除（履歴資産は保持）

## 4. リファクタリング対象領域

### A. 容量・運用

- `/.next` の定期クリーン
- `node_modules` の再利用戦略（CIキャッシュ、ローカル運用ルール）
- 生成物・ログの管理標準化

### B. フロントエンド構造

- `app/page.tsx` の責務分離（データ取得・表示・スタイルの分離）
- `Sidebar`/`MapContainer`/`Mobile*` の表示責務整理
- APIレスポンス型の統一

### C. API・ドメイン

- `/api/events` のクエリ責務分解（一覧・過去人気・検索）
- アーカイブ判定ロジックの共通化（実施済み基盤を拡張）
- エラーコード体系の統一（`DB_NOT_READY` 等）

### D. データ層

- Prisma schema のSQLite/PostgreSQL差分管理
- seedデータの責務明確化（開発確認用と検証用）
- popularity関連ロジックのドキュメント化

## 5. 優先順位（実施順）

### P0: すぐ実施（1日）

1. 容量運用ルール確定
2. クリーンコマンド追加（`clean` 系）
3. リファクタリング作業の受け入れ基準定義

### P1: 短期（1週間）

1. `app/page.tsx` 分割（data hook + presentation）
2. APIレスポンス型の統一ヘルパー導入
3. 過去人気セクションの取得・表示ロジック分離

### P2: 中期（2〜3週間）

1. map provider切替基盤を本実装（Google側実装時）
2. popularity算出をバッチ/イベントドリブンで標準化
3. E2E最小セット整備（投稿・終了・過去人気）

## 6. 受け入れ基準（Definition of Done）

- `npm run build` が成功
- 既存主要導線に回帰なし（一覧、投稿、編集、ログイン）
- 追加したロジックに対応したテスト/検証手順を記録
- 設計書（docs）に変更理由と影響範囲が追記済み

## 7. 運用ルール（容量対策）

### ローカル運用

- 作業終了時に不要なら `.next` を削除
- 定期的に `node_modules` を再生成せず、ロックファイルで依存固定
- DBファイルの保存先は運用方針を明記（`/tmp` 利用時は揮発注意）

### 推奨コマンド例

```bash
# 開発成果物のクリーン
rm -rf .next

# 完全クリーン（必要時のみ）
rm -rf node_modules .next
npm ci
```

## 8. 技術負債バックログ（初版）

1. `app/page.tsx` の肥大化（表示・取得・style定義が混在）
2. APIルートでの重複ハンドリング（P2021対応など）
3. イベント検索・フィルタ・人気表示の責務がUI寄りに偏在
4. popularity_score の更新規則が未定義
5. SQLite/PostgreSQLの運用差分が暗黙知

## 9. KPI

- ローカルディスク使用量（作業後）
- コールドビルド時間
- 主要画面の初回表示時間
- 変更1件あたりの影響ファイル数（小さいほど良い）

## 10. 変更管理

- 1テーマ1PR（または1コミット群）
- ドキュメント更新を同時提出
- 破壊的変更は事前にロールバック手順を記載

