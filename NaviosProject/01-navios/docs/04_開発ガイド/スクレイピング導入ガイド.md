# スクレイピング導入ガイド

最終更新: 2026-02-16

## このドキュメントについて

KCIC（`https://www.kcic.jp/event_list`）のイベント情報を、
Naviosの`Event`テーブル構造に合わせてCSV化し、Supabaseへ投入する手順をまとめています。

対象プロジェクト:
- `NaviosProject/01-navios/navios`

## 全体フロー

1. KCICのイベント一覧をスクレイピング
2. `Event`互換CSVを生成
3. Supabaseへ`createMany`で投入

## 事前準備

### 必須条件

- `node` と `npm` が使えること
- `navios` で `npm install` 済みであること
- Supabase接続文字列（`SUPABASE_DATABASE_URL`）を持っていること

### 実行ディレクトリ

```bash
cd /home/zer0/ドキュメント/NaviosProject/01-navios/navios
```

## 1. スクレイピングしてCSV作成

```bash
npm run scrape:events:csv -- \
  --url https://www.kcic.jp/event_list \
  --kcic-max-pages 3 \
  --default-lat 31.5966 \
  --default-lng 130.5571 \
  --out ./events_for_supabase.csv
```

### 主なオプション

- `--kcic-max-pages`: 何ページ分取得するか（例: `3`）
- `--default-lat`, `--default-lng`: 座標が無いイベントの補完値
- `--out`: 出力CSVパス

## 2. SupabaseへCSV投入

```bash
SUPABASE_DATABASE_URL="postgresql://..." \
npm run supabase:import:events:csv -- --file ./events_for_supabase.csv
```

## 3. よくあるエラーと対処

### `the URL must start with the protocol file:`

Prisma ClientがSQLite向けのままです。先にSupabase向け生成を実施:

```bash
npx prisma generate --schema prisma/schema.supabase.prisma
```

### `The column 'address' does not exist`

Supabase側スキーマが古い状態です。DBスキーマ同期:

```bash
DATABASE_URL="$SUPABASE_DATABASE_URL" \
npx prisma db push --schema prisma/schema.supabase.prisma
```

## 関連ファイル

- `navios/scripts/scrape-events-to-csv.mjs`
- `navios/scripts/import-events-csv-to-supabase.mjs`
- `navios/scripts/csv-utils.mjs`
- `navios/prisma/schema.supabase.prisma`
