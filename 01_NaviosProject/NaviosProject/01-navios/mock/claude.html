<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Navios - ãƒ©ã‚¤ãƒ•ãƒŠãƒ“OS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            brand: { 50:'#eef8ff',100:'#d8eeff',200:'#b9e0ff',300:'#89cfff',400:'#52b4ff',500:'#2a91ff',600:'#1a75f5',700:'#0f5ce1',800:'#134bb6',900:'#16428f' },
            surface: { 50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1' }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: #f0f4f8; color: #1e293b; overflow: hidden; height: 100dvh; }

    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
    .custom-scroll { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }

    #map { width: 100%; height: 100%; }

    .leaflet-popup-content-wrapper { border-radius: 16px; box-shadow: 0 20px 40px rgba(15,23,42,.18); padding: 0; overflow: hidden; }
    .leaflet-popup-content { margin: 0; width: 280px !important; }
    .leaflet-popup-tip { box-shadow: 0 4px 12px rgba(15,23,42,.12); }

    .glass { background: rgba(255,255,255,.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TIME-BASED MARKER SYSTEM
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* â”€â”€ Base pin â”€â”€ */
    .marker-pin { position: relative; width: 44px; height: 56px; display: flex; align-items: flex-start; justify-content: center; filter: drop-shadow(0 3px 6px rgba(15,23,42,.25)); transition: transform .2s ease; }
    .marker-pin .pin-body { width: 38px; height: 38px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); background: linear-gradient(135deg,#94a3b8,#64748b); border: 3px solid #fff; display: flex; align-items: center; justify-content: center; position: relative; }
    .marker-pin .pin-icon { transform: rotate(45deg); font-size: 15px; line-height: 1; }
    .marker-pin .pin-label { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); font-size: 9px; font-weight: 800; letter-spacing: .04em; padding: 2px 6px; border-radius: 6px; white-space: nowrap; pointer-events: none; line-height: 1.2; }

    /* â”€â”€ TODAY: ã‚´ãƒ¼ãƒ«ãƒ‰ + ã‚°ãƒ­ãƒ¼ + ãƒã‚¦ãƒ³ã‚¹ â”€â”€ */
    .marker-pin.pin-today { filter: drop-shadow(0 0 12px rgba(245,158,11,.5)) drop-shadow(0 4px 8px rgba(15,23,42,.3)); animation: pinBounce 2s ease-in-out infinite; width: 52px; height: 64px; }
    .marker-pin.pin-today .pin-body { width: 46px; height: 46px; background: linear-gradient(135deg,#f59e0b,#d97706); border: 3.5px solid #fff; box-shadow: 0 0 20px rgba(245,158,11,.4); }
    .marker-pin.pin-today .pin-icon { font-size: 18px; }
    .marker-pin.pin-today .pin-label { background: linear-gradient(135deg,#dc2626,#b91c1c); color: #fff; box-shadow: 0 2px 8px rgba(220,38,38,.4); }
    .marker-pin.pin-today .pin-pulse { position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 16px; height: 16px; border-radius: 50%; background: rgba(245,158,11,.4); animation: markerPulse 1.5s ease-out infinite; }
    .marker-pin.pin-today .pin-glow { position: absolute; inset: -8px; border-radius: 50%; background: radial-gradient(circle, rgba(245,158,11,.2) 0%, transparent 70%); animation: glowPulse 2s ease-in-out infinite; pointer-events: none; }

    @keyframes pinBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    @keyframes markerPulse {
      0% { transform: translateX(-50%) scale(1); opacity:.8; }
      100% { transform: translateX(-50%) scale(3.5); opacity:0; }
    }
    @keyframes glowPulse {
      0%, 100% { opacity: .6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.15); }
    }

    /* â”€â”€ UPCOMING (1ã€œ7æ—¥ä»¥å†…): ãƒ–ãƒ«ãƒ¼é€šå¸¸ â”€â”€ */
    .marker-pin.pin-upcoming .pin-body { background: linear-gradient(135deg,#2a91ff,#0f5ce1); }
    .marker-pin.pin-upcoming .pin-label { background: #dbeafe; color: #1d4ed8; }
    .marker-pin.pin-upcoming .pin-pulse { position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 12px; height: 12px; border-radius: 50%; background: rgba(42,145,255,.35); animation: markerPulse 2s ease-out infinite; }

    /* â”€â”€ ENDED: ã‚°ãƒ¬ãƒ¼ + åŠé€æ˜ + é™æ­¢ â”€â”€ */
    .marker-pin.pin-ended { opacity: .5; filter: grayscale(.6) drop-shadow(0 2px 4px rgba(15,23,42,.15)); width: 36px; height: 48px; }
    .marker-pin.pin-ended .pin-body { width: 32px; height: 32px; background: linear-gradient(135deg,#94a3b8,#64748b); border-width: 2px; }
    .marker-pin.pin-ended .pin-icon { font-size: 13px; }
    .marker-pin.pin-ended .pin-label { background: #f1f5f9; color: #94a3b8; }

    /* â”€â”€ Post Card â”€â”€ */
    .post-card { transition: transform .22s ease, box-shadow .22s ease; }
    .post-card:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(15,23,42,.12); }
    .post-card.active { border-color: #2a91ff; box-shadow: 0 0 0 3px rgba(42,145,255,.15), 0 12px 28px rgba(15,23,42,.12); }

    .status-badge { font-size: 10px; font-weight: 800; letter-spacing: .04em; padding: 3px 8px; border-radius: 6px; }

    /* â”€â”€ Bottom Sheet â”€â”€ */
    .bottom-sheet-overlay { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,.3); opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    .bottom-sheet-overlay.open { opacity: 1; pointer-events: auto; }
    .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; z-index: 2001; background: #fff; border-radius: 20px 20px 0 0; box-shadow: 0 -10px 40px rgba(15,23,42,.15); transform: translateY(100%); transition: transform .35s cubic-bezier(.32,.72,0,1); max-height: 75dvh; display: flex; flex-direction: column; }
    .bottom-sheet.open { transform: translateY(0); }
    .bottom-sheet .handle { width: 36px; height: 4px; border-radius: 99px; background: #cbd5e1; margin: 10px auto 0; flex-shrink: 0; }

    /* â”€â”€ Menu Drawer â”€â”€ */
    .menu-overlay { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,.4); opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    .menu-overlay.open { opacity: 1; pointer-events: auto; }
    .menu-drawer { position: fixed; top: 0; right: 0; bottom: 0; z-index: 3001; width: 300px; max-width: 85vw; background: #fff; transform: translateX(100%); transition: transform .35s cubic-bezier(.32,.72,0,1); display: flex; flex-direction: column; box-shadow: -8px 0 30px rgba(15,23,42,.12); }
    .menu-drawer.open { transform: translateX(0); }

    /* â”€â”€ Search â”€â”€ */
    .search-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background: #fff; border-radius: 0 0 16px 16px; box-shadow: 0 12px 32px rgba(15,23,42,.15); max-height: 260px; overflow-y: auto; display: none; }
    .search-results.show { display: block; }
    .search-result-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background .15s; }
    .search-result-item:hover { background: #f8fafc; }
    .search-result-item:last-child { border-bottom: none; border-radius: 0 0 16px 16px; }

    /* â”€â”€ Responsive â”€â”€ */
    .pc-sidebar { display: none; }
    .mobile-header { display: flex; }
    .pc-header { display: none; }
    .pc-map-overlays { display: none; }

    @media (min-width: 1025px) {
      .pc-sidebar { display: flex; }
      .mobile-header { display: none !important; }
      .pc-header { display: flex; }
      .pc-map-overlays { display: flex; }
      .mobile-fab { display: none !important; }
    }
  </style>
</head>
<body>

<div class="h-[100dvh] flex flex-col overflow-hidden">

  <!-- â•â•â•â•â•â•â•â•â•â• PC HEADER â•â•â•â•â•â•â•â•â•â• -->
  <header class="pc-header flex-shrink-0 bg-white border-b border-surface-200 px-6 py-3 items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center shadow-lg shadow-brand-500/25">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </div>
      <div>
        <h1 class="text-lg font-extrabold tracking-tight leading-none">Navios</h1>
        <p class="text-[11px] text-slate-400 font-medium tracking-wide">LIFE NAVI OS</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button class="flex items-center gap-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-semibold px-4 py-2 rounded-xl transition shadow-md shadow-brand-600/20">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
        æ–°è¦æŠ•ç¨¿
      </button>
      <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center text-white text-xs font-bold cursor-pointer">N</div>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â• MOBILE HEADER â•â•â•â•â•â•â•â•â•â• -->
  <header class="mobile-header flex-shrink-0 items-center gap-2 px-3 py-2 bg-white/90 backdrop-blur-xl border-b border-surface-200 z-[1100]" style="display:flex;">
    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center flex-shrink-0 shadow shadow-brand-500/20">
      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    </div>
    <div class="flex-1 relative" id="mobileSearchWrap">
      <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="mobileSearchInput" placeholder="å ´æ‰€ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢..." class="w-full pl-9 pr-3 py-2 text-sm bg-surface-50 border border-surface-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 transition">
      <div id="mobileSearchResults" class="search-results custom-scroll"></div>
    </div>
    <button id="btnHamburger" class="w-8 h-8 rounded-lg flex items-center justify-center border border-surface-200 hover:bg-surface-100 transition flex-shrink-0">
      <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â• -->
  <div class="flex-1 flex overflow-hidden">

    <!-- PC SIDEBAR -->
    <aside class="pc-sidebar flex-col bg-white border-r border-surface-200 overflow-hidden" style="width:380px;flex-shrink:0;">
      <div class="flex-shrink-0 p-4 border-b border-surface-100">
        <div class="relative" id="pcSearchWrap">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="pcSearchInput" placeholder="å ´æ‰€ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢..." class="w-full pl-10 pr-4 py-2.5 text-sm bg-surface-50 border border-surface-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 transition">
          <div id="pcSearchResults" class="search-results custom-scroll"></div>
        </div>
        <!-- Filter tabs -->
        <div class="flex gap-1.5 mt-3 flex-wrap">
          <button class="tab-btn active text-xs font-semibold px-3 py-1.5 rounded-lg bg-slate-800 text-white" data-filter="all">ã™ã¹ã¦</button>
          <button class="tab-btn text-xs font-semibold px-3 py-1.5 rounded-lg text-slate-500 hover:bg-surface-100" data-filter="today">TODAY</button>
          <button class="tab-btn text-xs font-semibold px-3 py-1.5 rounded-lg text-slate-500 hover:bg-surface-100" data-filter="upcoming">é–‹å‚¬äºˆå®š</button>
          <button class="tab-btn text-xs font-semibold px-3 py-1.5 rounded-lg text-slate-500 hover:bg-surface-100" data-filter="ended">çµ‚äº†</button>
        </div>
      </div>
      <div class="flex-shrink-0 px-4 py-2.5 flex items-center justify-between border-b border-surface-100">
        <p class="text-xs text-slate-400 font-medium"><span id="postCount" class="text-slate-700 font-bold">0</span> ã‚¤ãƒ™ãƒ³ãƒˆ</p>
      </div>
      <div id="postList" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2.5"></div>
    </aside>

    <!-- MAP -->
    <section class="flex-1 relative overflow-hidden">
      <div id="map"></div>

      <!-- PC overlays -->
      <div class="pc-map-overlays absolute top-4 left-4 right-4 z-[1000] items-start justify-between pointer-events-none">
        <div class="pointer-events-auto glass rounded-2xl px-4 py-3 border border-white/60 shadow-lg">
          <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-wider">è¡¨ç¤ºã‚¨ãƒªã‚¢</p>
          <p id="areaName" class="text-sm font-bold text-slate-800 mt-0.5">é¹¿å…å³¶çœŒæ—¥ç½®å¸‚</p>
        </div>
        <div class="pointer-events-auto glass rounded-2xl p-1.5 border border-white/60 shadow-lg flex gap-1">
          <button class="style-btn text-xs font-semibold px-3 py-1.5 rounded-xl bg-slate-800 text-white transition" data-style="voyager">Standard</button>
          <button class="style-btn text-xs font-semibold px-3 py-1.5 rounded-xl text-slate-500 hover:bg-white/60 transition" data-style="light">Light</button>
          <button class="style-btn text-xs font-semibold px-3 py-1.5 rounded-xl text-slate-500 hover:bg-white/60 transition" data-style="dark">Dark</button>
        </div>
      </div>

      <!-- PC stats -->
      <div class="pc-map-overlays absolute bottom-6 left-4 z-[1000] pointer-events-none">
        <div class="pointer-events-auto glass rounded-2xl px-4 py-3 border border-white/60 shadow-lg flex gap-5">
          <div>
            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-wider">Total</p>
            <p id="totalSpots" class="text-xl font-extrabold text-slate-800 leading-tight">0</p>
          </div>
          <div class="w-px bg-slate-200"></div>
          <div>
            <p class="text-[10px] font-semibold text-amber-500 uppercase tracking-wider">TODAY</p>
            <p id="todayCount" class="text-xl font-extrabold text-amber-500 leading-tight">0</p>
          </div>
          <div class="w-px bg-slate-200"></div>
          <div>
            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-wider">Upcoming</p>
            <p id="upcomingCount" class="text-xl font-extrabold text-brand-600 leading-tight">0</p>
          </div>
        </div>
      </div>

      <!-- Map buttons -->
      <div class="absolute bottom-6 right-4 z-[1000] flex flex-col gap-2">
        <button id="btnMyLocation" class="w-11 h-11 rounded-2xl glass border border-white/60 shadow-lg flex items-center justify-center hover:bg-white transition" title="ç¾åœ¨åœ°">
          <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2v2m0 16v2M2 12h2m16 0h2m-3.636-6.364l-1.414 1.414M7.05 16.95l-1.414 1.414M16.95 16.95l1.414 1.414M7.05 7.05L5.636 5.636M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>
        </button>
        <button id="btnResetView" class="w-11 h-11 rounded-2xl glass border border-white/60 shadow-lg flex items-center justify-center hover:bg-white transition" title="å…¨ä½“è¡¨ç¤º">
          <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </button>
      </div>

      <!-- Mobile badge -->
      <div class="mobile-fab absolute top-3 right-3 z-[1000]">
        <div class="glass rounded-full px-3 py-1.5 border border-white/60 shadow-lg flex items-center gap-1.5">
          <span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span>
          <span id="mobileSpotCount" class="text-xs font-bold text-slate-700">0</span>
          <span class="text-[10px] text-slate-400">events</span>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• BOTTOM SHEET â•â•â•â•â•â•â•â•â•â•â• -->
<div id="bottomSheetOverlay" class="bottom-sheet-overlay"></div>
<div id="bottomSheet" class="bottom-sheet">
  <div class="handle"></div>
  <div id="bottomSheetContent" class="flex-1 overflow-y-auto custom-scroll p-4"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• HAMBURGER DRAWER â•â•â•â•â•â•â•â•â•â•â• -->
<div id="menuOverlay" class="menu-overlay"></div>
<div id="menuDrawer" class="menu-drawer">
  <div class="p-5 border-b border-surface-200 flex items-center justify-between">
    <div class="flex items-center gap-2.5">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </div>
      <span class="font-extrabold text-base">Navios</span>
    </div>
    <button id="btnCloseMenu" class="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-surface-100 transition">
      <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
  </div>

  <!-- Filter by status -->
  <div class="p-4">
    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</p>
    <div class="space-y-1" id="menuFilterList">
      <button class="menu-filter-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-left transition hover:bg-surface-50 bg-brand-50" data-filter="all">
        <span class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-sm">ğŸ—º</span>
        <span class="text-sm font-semibold">ã™ã¹ã¦</span>
        <span class="ml-auto text-xs text-slate-400 font-medium" id="menuCountAll">0</span>
      </button>
      <button class="menu-filter-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-left transition hover:bg-surface-50" data-filter="today">
        <span class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center text-sm">ğŸ”¥</span>
        <span class="text-sm font-semibold">TODAY</span>
        <span class="ml-auto text-xs text-slate-400 font-medium" id="menuCountToday">0</span>
      </button>
      <button class="menu-filter-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-left transition hover:bg-surface-50" data-filter="upcoming">
        <span class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-sm">ğŸ“…</span>
        <span class="text-sm font-semibold">é–‹å‚¬äºˆå®š</span>
        <span class="ml-auto text-xs text-slate-400 font-medium" id="menuCountUpcoming">0</span>
      </button>
      <button class="menu-filter-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-left transition hover:bg-surface-50" data-filter="ended">
        <span class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-sm">ğŸ•</span>
        <span class="text-sm font-semibold">çµ‚äº†æ¸ˆã¿</span>
        <span class="ml-auto text-xs text-slate-400 font-medium" id="menuCountEnded">0</span>
      </button>
    </div>
  </div>

  <div class="border-t border-surface-100 mx-4"></div>

  <!-- Map Style -->
  <div class="p-4">
    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«</p>
    <div class="grid grid-cols-3 gap-2">
      <button class="menu-style-btn flex flex-col items-center gap-1.5 p-2.5 rounded-xl border-2 border-brand-500 bg-brand-50 transition" data-style="voyager">
        <span class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-lg">ğŸ—º</span>
        <span class="text-[11px] font-semibold">Standard</span>
      </button>
      <button class="menu-style-btn flex flex-col items-center gap-1.5 p-2.5 rounded-xl border-2 border-transparent hover:border-surface-200 transition" data-style="light">
        <span class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-lg">â˜€ï¸</span>
        <span class="text-[11px] font-semibold text-slate-500">Light</span>
      </button>
      <button class="menu-style-btn flex flex-col items-center gap-1.5 p-2.5 rounded-xl border-2 border-transparent hover:border-surface-200 transition" data-style="dark">
        <span class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-lg">ğŸŒ™</span>
        <span class="text-[11px] font-semibold text-slate-500">Dark</span>
      </button>
    </div>
  </div>

  <div class="border-t border-surface-100 mx-4"></div>
  <div class="p-4">
    <button class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-left hover:bg-surface-50 transition">
      <span class="w-8 h-8 rounded-lg bg-brand-50 flex items-center justify-center">
        <svg class="w-4 h-4 text-brand-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </span>
      <span class="text-sm font-semibold">æ–°è¦æŠ•ç¨¿</span>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENT DATA (æ–°ã‚¹ã‚­ãƒ¼ãƒ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TODAY = new Date().toISOString().slice(0, 10); // 'YYYY-MM-DD'

const events = [
  {
    id: 'evt-001',
    title: 'æ—¥ç½®å¸‚ æ˜¥ã®èŠ±ã¾ã¤ã‚Š 2026',
    content: 'æ—¥ç½®å¸‚æœ€å¤§ç´šã®æ˜¥ç¥­ã‚Šã€‚åœ°å…ƒã®å±‹å°ãŒ50åº—èˆ—ä»¥ä¸Šå‡ºåº—ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã¯éƒ·åœŸèŠ¸èƒ½ã‚„ãƒ©ã‚¤ãƒ–æ¼”å¥ãŒæ¥½ã—ã‚ã¾ã™ã€‚å®¶æ—é€£ã‚Œã«ã‚‚ãŠã™ã™ã‚ã€‚',
    latitude: 31.574500,
    longitude: 130.341800,
    event_date: TODAY,               // â† ä»Šæ—¥é–‹å‚¬
    expire_date: TODAY,
    event_image: 'https://placehold.co/400x240/f59e0b/ffffff?text=ğŸŒ¸+Spring+Festival'
  },
  {
    id: 'evt-002',
    title: 'å‰åˆ©ã®ä¸˜ å¤•ç„¼ã‘ãƒ•ã‚©ãƒˆã‚¦ã‚©ãƒ¼ã‚¯',
    content: 'å†™çœŸæ„›å¥½å®¶ã®ãŸã‚ã®æ’®å½±ã‚¤ãƒ™ãƒ³ãƒˆã€‚ãƒ—ãƒ­ã‚«ãƒ¡ãƒ©ãƒãƒ³ãŒåŒè¡Œã—ã€å¤•ç„¼ã‘ã®æ’®å½±ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’æ•™ã‚ã‚ŠãªãŒã‚‰çµ¶æ™¯ã‚¹ãƒãƒƒãƒˆã‚’å·¡ã‚Šã¾ã™ã€‚',
    latitude: 31.573710,
    longitude: 130.345154,
    event_date: TODAY,               // â† ä»Šæ—¥é–‹å‚¬
    expire_date: TODAY,
    event_image: 'https://placehold.co/400x240/ef4444/ffffff?text=ğŸ“¸+Photo+Walk'
  },
  {
    id: 'evt-003',
    title: 'éš ã‚Œå®¶ã‚«ãƒ•ã‚§ã€Œæœ¨æ¼ã‚Œæ—¥ã€ç‰¹åˆ¥ãƒ©ãƒ³ãƒä¼š',
    content: 'åœ°å…ƒè¾²å®¶ã‹ã‚‰ç›´é€ã®æ—¬ã®é‡èœã‚’ä½¿ã£ãŸç‰¹åˆ¥ã‚³ãƒ¼ã‚¹ãƒ©ãƒ³ãƒã€‚é™å®š20åã®äºˆç´„åˆ¶ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã€‚ãƒ†ãƒ©ã‚¹å¸­ã‹ã‚‰æ—¥ç½®ã®å±±ã€…ã‚’ä¸€æœ›ã€‚',
    latitude: 31.575100,
    longitude: 130.348000,
    event_date: (() => { const d = new Date(); d.setDate(d.getDate() + 2); return d.toISOString().slice(0,10); })(),
    expire_date: (() => { const d = new Date(); d.setDate(d.getDate() + 2); return d.toISOString().slice(0,10); })(),
    event_image: 'https://placehold.co/400x240/22c55e/ffffff?text=ğŸ½+Special+Lunch'
  },
  {
    id: 'evt-004',
    title: 'æ—¥å‰å¤é“ãƒŠã‚¤ãƒˆãƒã‚¤ã‚¯',
    content: 'æº€æœˆã®å¤œã«é–‹å‚¬ã•ã‚Œã‚‹ç‰¹åˆ¥ãªãƒã‚¤ã‚­ãƒ³ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã€‚ã‚¬ã‚¤ãƒ‰ä»˜ãã§æ­´å²ã‚ã‚‹çŸ³ç•³ã®å¤é“ã‚’æœˆæ˜ã‹ã‚Šã®ä¸‹ã§æ­©ãã¾ã™ã€‚ãƒ˜ãƒƒãƒ‰ãƒ©ãƒ³ãƒ—è²¸å‡ºã‚ã‚Šã€‚',
    latitude: 31.571800,
    longitude: 130.343000,
    event_date: (() => { const d = new Date(); d.setDate(d.getDate() + 5); return d.toISOString().slice(0,10); })(),
    expire_date: (() => { const d = new Date(); d.setDate(d.getDate() + 5); return d.toISOString().slice(0,10); })(),
    event_image: 'https://placehold.co/400x240/6366f1/ffffff?text=ğŸŒ•+Night+Hike'
  },
  {
    id: 'evt-005',
    title: 'å‰åˆ©å· æ¡œãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—',
    content: 'å·æ²¿ã„ã®æ¡œä¸¦æœ¨ã‚’å¹»æƒ³çš„ã«ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—ã€‚å±‹å°ã®å‡ºåº—ã‚„åœ°å…ƒãƒŸãƒ¥ãƒ¼ã‚¸ã‚·ãƒ£ãƒ³ã®æ¼”å¥ã‚‚ã‚ã‚Šã€‚æœŸé–“ä¸­æ¯æ—¥18:00ã€œ21:00é–‹å‚¬ã€‚',
    latitude: 31.572200,
    longitude: 130.346500,
    event_date: (() => { const d = new Date(); d.setDate(d.getDate() - 3); return d.toISOString().slice(0,10); })(),
    expire_date: (() => { const d = new Date(); d.setDate(d.getDate() - 1); return d.toISOString().slice(0,10); })(),
    event_image: 'https://placehold.co/400x240/ec4899/ffffff?text=ğŸŒ¸+Sakura+Light'
  },
  {
    id: 'evt-006',
    title: 'æ¼æ¸¯æœå¸‚ & æµ·é®®BBQãƒ•ã‚§ã‚¹',
    content: 'æ¯æœˆæ’ä¾‹ã®æœå¸‚ã«åŠ ãˆã€ä»Šå›ã¯æµ·é®®BBQç‰¹åˆ¥ä¼ç”»ã€‚æœç²ã‚Œã®æ–°é®®ãªé­šä»‹ã‚’è‡ªåˆ†ã§ç„¼ã„ã¦æ¥½ã—ã‚ã¾ã™ã€‚æœ6:00ã‚¹ã‚¿ãƒ¼ãƒˆã€‚',
    latitude: 31.576000,
    longitude: 130.350200,
    event_date: (() => { const d = new Date(); d.setDate(d.getDate() - 10); return d.toISOString().slice(0,10); })(),
    expire_date: (() => { const d = new Date(); d.setDate(d.getDate() - 10); return d.toISOString().slice(0,10); })(),
    event_image: 'https://placehold.co/400x240/f97316/ffffff?text=ğŸ¦+Seafood+BBQ'
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIME STATUS LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getEventStatus(evt) {
  const today = TODAY;
  if (evt.event_date <= today && evt.expire_date >= today) return 'today';
  if (evt.event_date > today) return 'upcoming';
  return 'ended';
}

const STATUS_CONFIG = {
  today:    { label: 'TODAY',   labelShort: 'NOW',  pinClass: 'pin-today',    badgeClass: 'bg-amber-100 text-amber-700', emoji: 'ğŸ”¥', icon: 'ğŸ“' },
  upcoming: { label: 'é–‹å‚¬äºˆå®š', labelShort: 'SOON', pinClass: 'pin-upcoming', badgeClass: 'bg-blue-50 text-blue-700',    emoji: 'ğŸ“…', icon: 'ğŸ“Œ' },
  ended:    { label: 'çµ‚äº†',    labelShort: 'END',  pinClass: 'pin-ended',    badgeClass: 'bg-slate-100 text-slate-500',  emoji: 'ğŸ•', icon: 'ğŸ“' },
};

function formatDateRange(start, end) {
  const s = new Date(start);
  const e = new Date(end);
  const fmt = (d) => `${d.getMonth()+1}/${d.getDate()}`;
  return start === end ? fmt(s) : `${fmt(s)} ã€œ ${fmt(e)}`;
}

function daysUntilText(evt) {
  const status = getEventStatus(evt);
  if (status === 'today') return 'é–‹å‚¬ä¸­';
  if (status === 'upcoming') {
    const diff = Math.ceil((new Date(evt.event_date) - new Date(TODAY)) / 86400000);
    return `ã‚ã¨${diff}æ—¥`;
  }
  const diff = Math.ceil((new Date(TODAY) - new Date(evt.expire_date)) / 86400000);
  return `${diff}æ—¥å‰ã«çµ‚äº†`;
}

const isMobile = () => window.matchMedia('(max-width: 1024px)').matches;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', { zoomControl: false, attributionControl: true }).setView([31.573710, 130.345154], 14);
L.control.zoom({ position: 'bottomright' }).addTo(map);

const tileLayers = {
  voyager: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom:20, attribution:'&copy; OpenStreetMap &copy; CARTO' }),
  light:   L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:20, attribution:'&copy; OpenStreetMap &copy; CARTO' }),
  dark:    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:20, attribution:'&copy; OpenStreetMap &copy; CARTO' })
};
let currentTileLayer = tileLayers.voyager;
currentTileLayer.addTo(map);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKER SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createMarkerIcon(evt) {
  const status = getEventStatus(evt);
  const cfg = STATUS_CONFIG[status];
  const sizeClass = status === 'today' ? 'iconSize:[52,64],iconAnchor:[26,64]' : status === 'ended' ? 'iconSize:[36,48],iconAnchor:[18,48]' : 'iconSize:[44,56],iconAnchor:[22,56]';

  let extraHTML = '';
  if (status === 'today') {
    extraHTML = `<span class="pin-pulse"></span><span class="pin-glow"></span><span class="pin-label">${cfg.labelShort}</span>`;
  } else if (status === 'upcoming') {
    extraHTML = `<span class="pin-pulse"></span><span class="pin-label">${cfg.labelShort}</span>`;
  } else {
    extraHTML = `<span class="pin-label">${cfg.labelShort}</span>`;
  }

  const sizes = {
    today:    { iconSize: [52,64], iconAnchor: [26,64], popupAnchor: [0,-62] },
    upcoming: { iconSize: [44,56], iconAnchor: [22,56], popupAnchor: [0,-54] },
    ended:    { iconSize: [36,48], iconAnchor: [18,48], popupAnchor: [0,-46] },
  };

  return L.divIcon({
    html: `<div class="marker-pin ${cfg.pinClass}"><div class="pin-body"><span class="pin-icon">${cfg.icon}</span></div>${extraHTML}</div>`,
    className: '',
    ...sizes[status]
  });
}

const markerMap = {};

events.forEach(evt => {
  const marker = L.marker([evt.latitude, evt.longitude], {
    icon: createMarkerIcon(evt),
    zIndexOffset: getEventStatus(evt) === 'today' ? 1000 : getEventStatus(evt) === 'upcoming' ? 500 : 0
  }).addTo(map);
  marker.on('click', () => onEventSelect(evt));
  markerMap[evt.id] = marker;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENT SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createPopupHTML(evt) {
  const status = getEventStatus(evt);
  const cfg = STATUS_CONFIG[status];
  return `<div style="width:280px">
    <div style="position:relative;">
      <img src="${evt.event_image}" alt="${evt.title}" style="width:100%;height:150px;object-fit:cover;">
      <span class="status-badge ${cfg.badgeClass}" style="position:absolute;top:10px;left:10px;">${cfg.emoji} ${cfg.label}</span>
    </div>
    <div style="padding:14px 16px 16px;">
      <p style="margin:0 0 6px;font-size:15px;font-weight:700;color:#1e293b;">${evt.title}</p>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span style="font-size:12px;color:#64748b;">ğŸ“… ${formatDateRange(evt.event_date, evt.expire_date)}</span>
        <span style="font-size:11px;font-weight:700;color:${status==='today'?'#d97706':status==='upcoming'?'#2563eb':'#94a3b8'};">${daysUntilText(evt)}</span>
      </div>
      <p style="margin:0 0 12px;font-size:12px;color:#64748b;line-height:1.6;">${evt.content.slice(0, 80)}...</p>
      <a href="detail.html?id=${evt.id}" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;background:#1e293b;color:#fff;font-size:12px;font-weight:700;padding:8px 14px;border-radius:10px;">
        è©³ç´°ã‚’è¦‹ã‚‹
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
      </a>
    </div>
  </div>`;
}

function onEventSelect(evt) {
  if (isMobile()) {
    openBottomSheet(evt);
    map.flyTo([evt.latitude, evt.longitude], 16, { duration: 0.6 });
  } else {
    const marker = markerMap[evt.id];
    marker.unbindPopup();
    marker.bindPopup(createPopupHTML(evt), { maxWidth: 300, closeButton: true }).openPopup();
    map.flyTo([evt.latitude, evt.longitude], 17, { duration: 0.8 });
    const card = document.querySelector(`#postList [data-id="${evt.id}"]`);
    if (card) {
      document.querySelectorAll('#postList .post-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOTTOM SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const bottomSheet = document.getElementById('bottomSheet');
const bottomSheetOverlay = document.getElementById('bottomSheetOverlay');
const bottomSheetContent = document.getElementById('bottomSheetContent');

function openBottomSheet(evt) {
  const status = getEventStatus(evt);
  const cfg = STATUS_CONFIG[status];
  bottomSheetContent.innerHTML = `
    <div class="relative -mx-4 -mt-4 mb-4">
      <img src="${evt.event_image}" alt="${evt.title}" class="w-full h-48 object-cover rounded-t-2xl">
      <span class="absolute top-3 left-3 status-badge ${cfg.badgeClass} backdrop-blur-sm shadow">${cfg.emoji} ${cfg.label}</span>
      <div class="absolute top-3 right-3 glass rounded-lg px-2.5 py-1 shadow">
        <span class="text-xs font-bold" style="color:${status==='today'?'#d97706':status==='upcoming'?'#2563eb':'#94a3b8'}">${daysUntilText(evt)}</span>
      </div>
    </div>
    <h2 class="text-lg font-extrabold text-slate-900 mb-2">${evt.title}</h2>
    <div class="flex items-center gap-2 mb-3 flex-wrap">
      <div class="flex items-center gap-1.5 text-slate-500">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <span class="text-xs font-medium">${formatDateRange(evt.event_date, evt.expire_date)}</span>
      </div>
    </div>
    <p class="text-sm text-slate-600 leading-relaxed mb-5">${evt.content}</p>
    <div class="flex gap-2">
      <a href="detail.html?id=${evt.id}" class="flex-1 flex items-center justify-center gap-2 bg-slate-900 text-white text-sm font-bold py-3 rounded-xl no-underline">
        è©³ç´°ã‚’è¦‹ã‚‹
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
      </a>
      <button onclick="closeBottomSheet()" class="px-4 py-3 rounded-xl border border-surface-200 text-sm font-semibold text-slate-500 hover:bg-surface-50 transition">é–‰ã˜ã‚‹</button>
    </div>
  `;
  bottomSheet.classList.add('open');
  bottomSheetOverlay.classList.add('open');
}

function closeBottomSheet() {
  bottomSheet.classList.remove('open');
  bottomSheetOverlay.classList.remove('open');
}
bottomSheetOverlay.addEventListener('click', closeBottomSheet);

let sheetStartY = 0;
bottomSheet.addEventListener('touchstart', (e) => { sheetStartY = e.touches[0].clientY; }, { passive: true });
bottomSheet.addEventListener('touchmove', (e) => { if (e.touches[0].clientY - sheetStartY > 80) closeBottomSheet(); }, { passive: true });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HAMBURGER MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const menuOverlay = document.getElementById('menuOverlay');
const menuDrawer = document.getElementById('menuDrawer');

function openMenu() { menuDrawer.classList.add('open'); menuOverlay.classList.add('open'); }
function closeMenu() { menuDrawer.classList.remove('open'); menuOverlay.classList.remove('open'); }
document.getElementById('btnHamburger').addEventListener('click', openMenu);
document.getElementById('btnCloseMenu').addEventListener('click', closeMenu);
menuOverlay.addEventListener('click', closeMenu);

// Menu filter buttons
document.querySelectorAll('.menu-filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    currentFilter = btn.dataset.filter;
    document.querySelectorAll('.menu-filter-btn').forEach(b => b.classList.remove('bg-brand-50'));
    btn.classList.add('bg-brand-50');
    syncTabButtons();
    applyFilter();
    closeMenu();
  });
});

// Menu style
document.querySelectorAll('.menu-style-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    setMapStyle(btn.dataset.style);
    document.querySelectorAll('.menu-style-btn').forEach(b => {
      b.classList.remove('border-brand-500', 'bg-brand-50'); b.classList.add('border-transparent');
    });
    btn.classList.add('border-brand-500', 'bg-brand-50'); btn.classList.remove('border-transparent');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP STYLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMapStyle(style) {
  map.removeLayer(currentTileLayer);
  currentTileLayer = tileLayers[style];
  currentTileLayer.addTo(map);
  document.querySelectorAll('.style-btn').forEach(b => { b.classList.remove('bg-slate-800','text-white'); b.classList.add('text-slate-500'); });
  const pcBtn = document.querySelector(`.style-btn[data-style="${style}"]`);
  if (pcBtn) { pcBtn.classList.add('bg-slate-800','text-white'); pcBtn.classList.remove('text-slate-500'); }
}
document.querySelectorAll('.style-btn').forEach(btn => {
  btn.addEventListener('click', () => setMapStyle(btn.dataset.style));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER & RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentFilter = 'all';

function syncTabButtons() {
  document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('bg-slate-800','text-white'); b.classList.add('text-slate-500'); });
  const t = document.querySelector(`.tab-btn[data-filter="${currentFilter}"]`);
  if (t) { t.classList.add('bg-slate-800','text-white'); t.classList.remove('text-slate-500'); }
}

function applyFilter() {
  const query = (isMobile()
    ? document.getElementById('mobileSearchInput').value
    : document.getElementById('pcSearchInput').value
  ).toLowerCase();

  const filtered = events.filter(evt => {
    const status = getEventStatus(evt);
    const matchFilter = currentFilter === 'all' || currentFilter === status;
    const matchQ = !query || evt.title.includes(query) || evt.content.includes(query);
    return matchFilter && matchQ;
  });

  // Marker visibility
  events.forEach(evt => {
    const marker = markerMap[evt.id];
    const show = filtered.includes(evt);
    if (show && !map.hasLayer(marker)) marker.addTo(map);
    if (!show && map.hasLayer(marker)) map.removeLayer(marker);
  });

  // Counts
  const todayEvents = events.filter(e => getEventStatus(e) === 'today');
  const upcomingEvents = events.filter(e => getEventStatus(e) === 'upcoming');
  const endedEvents = events.filter(e => getEventStatus(e) === 'ended');

  document.getElementById('mobileSpotCount').textContent = filtered.length;
  const pc = document.getElementById('postCount'); if (pc) pc.textContent = filtered.length;
  const ts = document.getElementById('totalSpots'); if (ts) ts.textContent = events.length;
  const tc = document.getElementById('todayCount'); if (tc) tc.textContent = todayEvents.length;
  const uc = document.getElementById('upcomingCount'); if (uc) uc.textContent = upcomingEvents.length;
  document.getElementById('menuCountAll').textContent = events.length;
  document.getElementById('menuCountToday').textContent = todayEvents.length;
  document.getElementById('menuCountUpcoming').textContent = upcomingEvents.length;
  document.getElementById('menuCountEnded').textContent = endedEvents.length;

  // Sort: today first, then upcoming, then ended
  const sorted = [...filtered].sort((a, b) => {
    const order = { today: 0, upcoming: 1, ended: 2 };
    return order[getEventStatus(a)] - order[getEventStatus(b)];
  });

  renderSidebar(sorted);
}

function renderSidebar(filteredEvents) {
  const el = document.getElementById('postList');
  if (!el) return;
  el.innerHTML = filteredEvents.map(evt => {
    const status = getEventStatus(evt);
    const cfg = STATUS_CONFIG[status];
    const borderAccent = status === 'today' ? 'border-l-4 border-l-amber-400' : status === 'upcoming' ? 'border-l-4 border-l-blue-400' : 'border-l-4 border-l-slate-200';
    return `
      <article class="post-card bg-white rounded-2xl border border-surface-200 ${borderAccent} overflow-hidden cursor-pointer ${status === 'ended' ? 'opacity-60' : ''}" data-id="${evt.id}">
        <div class="relative">
          <img src="${evt.event_image}" alt="${evt.title}" class="w-full h-32 object-cover">
          <span class="absolute top-2 left-2 status-badge ${cfg.badgeClass} backdrop-blur-sm">${cfg.emoji} ${cfg.label}</span>
          <div class="absolute top-2 right-2 glass rounded-lg px-2 py-0.5">
            <span class="text-[11px] font-bold" style="color:${status==='today'?'#d97706':status==='upcoming'?'#2563eb':'#94a3b8'}">${daysUntilText(evt)}</span>
          </div>
        </div>
        <div class="p-3.5">
          <h3 class="text-sm font-bold text-slate-800 mb-1 leading-snug">${evt.title}</h3>
          <div class="flex items-center gap-1.5 mb-2 text-slate-400">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <span class="text-[11px]">${formatDateRange(evt.event_date, evt.expire_date)}</span>
          </div>
          <p class="text-xs text-slate-500 leading-relaxed" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${evt.content}</p>
        </div>
      </article>`;
  }).join('');

  el.querySelectorAll('.post-card').forEach(card => {
    card.addEventListener('click', () => {
      const evt = events.find(e => e.id === card.dataset.id);
      if (evt) onEventSelect(evt);
    });
  });
}

// PC tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    currentFilter = btn.dataset.filter;
    syncTabButtons();
    document.querySelectorAll('.menu-filter-btn').forEach(b => b.classList.remove('bg-brand-50'));
    const mb = document.querySelector(`.menu-filter-btn[data-filter="${currentFilter}"]`);
    if (mb) mb.classList.add('bg-brand-50');
    applyFilter();
  });
});

// Search
document.getElementById('mobileSearchInput').addEventListener('input', () => { applyFilter(); geocodeSearch('mobile'); });
document.getElementById('pcSearchInput').addEventListener('input', () => { applyFilter(); geocodeSearch('pc'); });

applyFilter();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOCODING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let geocodeTimer = null;
function geocodeSearch(mode) {
  const input = mode === 'mobile' ? document.getElementById('mobileSearchInput') : document.getElementById('pcSearchInput');
  const resultsEl = mode === 'mobile' ? document.getElementById('mobileSearchResults') : document.getElementById('pcSearchResults');
  const query = input.value.trim();
  if (query.length < 2) { resultsEl.classList.remove('show'); return; }
  clearTimeout(geocodeTimer);
  geocodeTimer = setTimeout(async () => {
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=jp&limit=5&accept-language=ja`);
      const data = await res.json();
      if (!data.length) { resultsEl.classList.remove('show'); return; }
      resultsEl.innerHTML = data.map(item => `
        <div class="search-result-item" data-lat="${item.lat}" data-lon="${item.lon}">
          <p class="text-sm font-semibold text-slate-800 mb-0.5">${item.display_name.split(',')[0]}</p>
          <p class="text-xs text-slate-400 truncate">${item.display_name}</p>
        </div>`).join('');
      resultsEl.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          map.flyTo([parseFloat(item.dataset.lat), parseFloat(item.dataset.lon)], 14, { duration: 1 });
          resultsEl.classList.remove('show');
          input.value = '';
          applyFilter();
        });
      });
      resultsEl.classList.add('show');
    } catch { resultsEl.classList.remove('show'); }
  }, 400);
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('#mobileSearchWrap')) document.getElementById('mobileSearchResults').classList.remove('show');
  if (!e.target.closest('#pcSearchWrap')) document.getElementById('pcSearchResults').classList.remove('show');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP BUTTONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btnResetView').addEventListener('click', () => {
  const bounds = L.latLngBounds(events.map(e => [e.latitude, e.longitude]));
  map.flyToBounds(bounds.pad(0.2), { duration: 0.8 });
});
document.getElementById('btnMyLocation').addEventListener('click', () => {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    pos => map.flyTo([pos.coords.latitude, pos.coords.longitude], 15, { duration: 1 }),
    () => {}, { enableHighAccuracy: true }
  );
});
</script>
</body>
</html>
